name: Quality Gate

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run all quality checks
      run: |
        echo "🔍 Running TypeScript type checking..."
        npm run typecheck
        echo "✅ Type checking passed"
        
        echo "🎯 Running ESLint..."
        npm run lint
        echo "✅ Linting passed"
        
        echo "🧪 Running unit tests with coverage..."
        npm run test:coverage
        echo "✅ Tests passed"

    - name: Check test coverage threshold
      run: |
        echo "📊 Checking coverage thresholds..."
        COVERAGE=$(npm run test:coverage --silent | grep "All files" | grep -o '[0-9]*\.[0-9]*' | head -1)
        THRESHOLD=60
        
        echo "Current coverage: ${COVERAGE}%"
        echo "Required threshold: ${THRESHOLD}%"
        
        if (( $(echo "${COVERAGE} >= ${THRESHOLD}" | bc -l) )); then
          echo "✅ Coverage threshold met: ${COVERAGE}% >= ${THRESHOLD}%"
        else
          echo "❌ Coverage below threshold: ${COVERAGE}% < ${THRESHOLD}%"
          exit 1
        fi

    - name: Validate package.json
      run: |
        echo "📦 Validating package.json structure..."
        node -e "
          const pkg = require('./package.json');
          const required = ['name', 'version', 'description', 'main', 'bin', 'scripts', 'dependencies', 'devDependencies'];
          const missing = required.filter(field => !pkg[field]);
          if (missing.length) {
            console.log('❌ Missing required fields:', missing.join(', '));
            process.exit(1);
          }
          console.log('✅ Package.json structure valid');
        "

    - name: Check for security vulnerabilities
      run: |
        echo "🔒 Checking for security vulnerabilities..."
        npm audit --audit-level high
        echo "✅ Security check passed"

  # Prevent merge if quality gate fails
  block-merge-on-failure:
    runs-on: ubuntu-latest
    needs: quality-checks
    if: failure()
    
    steps:
    - name: Block merge
      run: |
        echo "❌ Quality gate failed - PR cannot be merged"
        echo "Please fix the issues above before merging"
        exit 1